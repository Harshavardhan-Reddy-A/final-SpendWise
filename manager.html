<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>manager.html</title>
    <link rel="stylesheet" href="manager.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div class="left-nav-buttons"> 
            <button id="profileBtn" class="header-nav-btn">My Profile</button>
            <button id="homeBtn" class="header-nav-btn">Upload Data</button>
        </div>
        <div class="header-title">SpendWise</div>
        <div class="nav-buttons">
            <button id="manageBtn" class="header-nav-btn">Manager</button>
            <button id="analyzeBtn" class="header-nav-btn">Analysis</button>
            <button id="predictBtn" class="header-nav-btn">Prediction</button>
        </div>
    </header>

    <div class="container">
        <aside class="sidebar">
            <div class="period-select">
                <div class="period-item">
                    <label for="scopeSelect">Report Scope:</label>
                    <select id="scopeSelect">
                        <option value="monthly" selected>Monthly Report</option>
                        <option value="yearly">Annual Report</option>
                    </select>
                </div>
                
                <div class="period-item" id="yearSelectorContainer">
                    <label for="yearSelect">Year:</label>
                    <select id="yearSelect"></select>
                </div>

                <div class="period-item" id="monthSelectorContainer">
                    <label for="monthSelect">Month:</label>
                    <select id="monthSelect"></select>
                </div>
            </div>
        </aside>

        <main class="main-area">
            <h2 id="summaryTitle">Financial Summary (Loading...)</h2>
            <div class="summary-cards">
                <div class="card">
                    <p>Total Income:</p>
                    <h3 id="totalIncome">$0</h3>
                </div>
                <div class="card">
                    <p>Total Expenditure (Excl. Savings/Transfer):</p>
                    <h3 id="totalSpent">$0</h3>
                </div>

                <div class="card">
                    <p>Net Financial Change (Income - Spent):</p>
                    <h3 id="netChange">$0</h3>
                </div>
            </div>
            
            <div id="balanceAlertBox" class="card full-width" style="margin-bottom: 20px;">
                <h3>Financial Health Monitor</h3>
                <div id="balanceAlert"><p>Awaiting data analysis...</p></div>
            </div>

            <div class="card full-width" id="categoryTrendGraphCard">
                <h3>Top 5 Category Spending Trend</h3>
                <div id="categoryTrendGraph">
                    <canvas id="categoryTrendCanvas" width="800" height="300"></canvas>
                    <div id="trendLegend" class="chart-legend"></div>
                </div>
            </div>
            
            <div id="wastedMoneyBox" class="card full-width"> 
                <h3>Discretionary Spending Review</h3>
                <div id="wastedContent"><p>Loading waste analysis...</p></div>
            </div>
            
        </main>
    </div>

    <script type="module" src="manager.js"></script>
    <script type="module">
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Navigation redirects & Auth Guard
        document.getElementById('profileBtn').addEventListener('click', () => { window.location.href = 'profile.html'; });
        document.getElementById('homeBtn').addEventListener('click', () => { window.location.href = 'upload.html'; }); // UPDATED
        document.getElementById("manageBtn").addEventListener("click", () => { window.location.href = "manager.html"; });
        document.getElementById("analyzeBtn").addEventListener("click", () => { window.location.href = "analysis.html"; });
        document.getElementById("predictBtn").addEventListener("click", () => { window.location.href = "prediction.html"; });

        // Dynamic Logout Button Creation (Standard across all content pages)
        window.onload = () => {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                
                onAuthStateChanged(auth, (user) => {
                    const navButtons = document.querySelector('.nav-buttons');
                    let logoutBtn = document.getElementById('logoutBtn');
                    
                    if (!user || !user.email) {
                        // Check local storage for the demo user
                        if (!localStorage.getItem('currentUser')) {
                            window.location.href = 'index.html'; // UPDATED REDIRECT
                        }
                    } else {
                        if (!logoutBtn) {
                           logoutBtn = document.createElement('button');
                           logoutBtn.id = 'logoutBtn';
                           logoutBtn.className = 'header-nav-btn';
                           logoutBtn.textContent = 'Sign Out';
                           navButtons.appendChild(logoutBtn);
                           
                           logoutBtn.addEventListener('click', async () => {
                               await signOut(auth);
                               localStorage.removeItem('currentUser');
                           });
                        }
                    }
                });
            } catch (error) {
                console.warn("Firebase check failed. Ensure Firebase config is available.");
                // Non-Firebase path: Check if local storage user exists
                if (!localStorage.getItem('currentUser')) {
                    setTimeout(() => { 
                        if (!localStorage.getItem('currentUser')) {
                            window.location.href = 'index.html'; // UPDATED REDIRECT
                        }
                    }, 500);
                }
            }
        };
    </script>
</body>
</html>